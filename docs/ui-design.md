# UI設計書

## 概要

GraphVerseの主要UI設計について詳細を定義します。特に新機能のMerge/新トピック機能を含むUI構成を中心に記述します。

## コンポーネント構成

### 1. メインレイアウト (src/app/page.tsx)

```
┌─────────────────────────────────────────────────────────────┐
│                    Header                                   │
│  [Session List] [New Session] [Current: "Session Name"]    │
├─────────────────────┬───────────────────────────────────────┤
│                     │                                       │
│    GraphView        │           BranchView                  │
│   (左側 60%)        │          (右側 40%)                   │
│                     │                                       │
│  ┌─────────────────┐│  ┌─────────────────────────────────┐  │
│  │   [Merge Mode]  ││  │     Selected Context            │  │
│  │      Button     ││  │   ┌───────────────────────────┐ │  │
│  ├─────────────────┤│  │   │ Node 1: "AI概要説明..."   │ │  │
│  │                 ││  │   │ Tokens: 120               │ │  │
│  │   Graph Nodes   ││  │   └───────────────────────────┘ │  │
│  │   & Edges       ││  │   ┌───────────────────────────┐ │  │
│  │                 ││  │   │ Node 2: "詳細解説..."     │ │  │
│  │  ●──────●───●   ││  │   │ Tokens: 85                │ │  │
│  │     │    │   │   ││  │   └───────────────────────────┘ │  │
│  │     ●    ●   ●   ││  │   Total: 205/128000 tokens    │  │
│  │          │       ││  ├─────────────────────────────────┤
│  │          ●       ││  │     Chat History                │  │
│  │                 ││  │   [User]: 最初の質問...          │  │
│  │                 ││  │   [AI]: 回答...                 │  │
│  └─────────────────┘│  │   [User]: 続きの質問...          │  │
│                     │  │   [AI]: 詳細な回答...           │  │
│                     │  ├─────────────────────────────────┤
│                     │  │     New Chat Input              │  │
│                     │  │  ┌─────────────────────────────┐ │  │
│                     │  │  │ メッセージを入力...          │ │  │
│                     │  │  └─────────────────────────────┘ │  │
│                     │  │  [Send] [New Topic]             │  │
│                     │  └─────────────────────────────────┘  │
└─────────────────────┴───────────────────────────────────────┘
```

### 2. Mergeモード時のレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│                    Header                                   │
│                [Exit Merge Mode]                            │
├─────────────────────┬───────────────────────────────────────┤
│                     │                                       │
│    GraphView        │           MergePanel                  │
│  (Merge Selection)  │                                       │
│                     │                                       │
│  ┌─────────────────┐│  ┌─────────────────────────────────┐  │
│  │ 📌 Click nodes  ││  │     Selected for Merge          │  │
│  │ to select       ││  │   ┌───────────────────────────┐ │  │
│  ├─────────────────┤│  │   │ ✓ Node 1: "概要..." [×] │ │  │
│  │                 ││  │   │   Tokens: 120             │ │  │
│  │   ●──────●───●   ││  │   └───────────────────────────┘ │  │
│  │  [✓]    [ ]  [ ] ││  │   ┌───────────────────────────┐ │  │
│  │     ●    ●   ●   ││  │   │ ✓ Node 3: "具体例..." [×]│ │  │
│  │    [✓]  [ ] [ ]  ││  │   │   Tokens: 95              │ │  │
│  │          ●       ││  │   └───────────────────────────┘ │  │
│  │         [ ]      ││  │   Total: 215/128000 tokens    │  │
│  └─────────────────┘│  ├─────────────────────────────────┤
│                     │  │     Merge Prompt                │  │
│                     │  │  ┌─────────────────────────────┐ │  │
│                     │  │  │ 選択したコンテキストを元に │ │  │
│                     │  │  │ 新しい質問を入力...          │ │  │
│                     │  │  └─────────────────────────────┘ │  │
│                     │  │  [Execute Merge] [Cancel]       │  │
│                     │  ├─────────────────────────────────┤
│                     │  │     Preview                     │  │
│                     │  │  Context: Node1, Node3          │  │
│                     │  │  Type: Merge                    │  │
│                     │  └─────────────────────────────────┘  │
└─────────────────────┴───────────────────────────────────────┘
```

## 主要コンポーネントの詳細

### 3.1 GraphView (src/components/graph/GraphView.tsx)

**責務**:
- React Flowを使用したグラフの表示
- ノードの選択・ハイライト表示
- Mergeモード時の複数選択UI

**主要機能**:
- 通常モード: ノードをクリックでBranchViewに反映
- Mergeモード: 複数ノード選択（チェックボックス表示）
- ズーム・パン操作
- エッジの表示（親子関係・merge関係の区別）

**状態**:
- `nodes`: 現在のセッションのノード一覧
- `edges`: エッジ一覧
- `selectedNodes`: 選択中のノード（Mergeモード時）
- `isMergeMode`: Mergeモードの状態

### 3.2 BranchView (src/components/branch/BranchView.tsx)

**責務**:
- 選択されたコンテキストの表示
- チャット履歴の時系列表示
- 新しいメッセージの入力

**主要機能**:
- コンテキスト一覧（トークン数付き）
- チャット履歴（ユーザー・AI区別）
- 新規入力フォーム
- 「新トピック」ボタン（コンテキストクリア）

**状態**:
- `selectedContext`: 選択中のコンテキストノード
- `chatHistory`: 表示するチャット履歴
- `inputText`: 入力中のテキスト

### 3.3 MergePanel (src/components/merge/MergePanel.tsx)

**責務**:
- Mergeモード専用の操作パネル
- 選択ノードの管理
- Merge実行

**主要機能**:
- 選択ノード一覧表示（削除可能）
- トークン数集計・制限チェック
- Mergeプロンプト入力
- 実行・キャンセルボタン

### 3.4 ContextManager (src/components/context/ContextManager.tsx)

**責務**:
- コンテキスト選択の管理
- トークン制限の監視・表示
- 選択状態の可視化

**主要機能**:
- トークン数リアルタイム計算
- 制限超過時の警告表示
- 個別ノード削除機能

## 操作フロー

### 4.1 通常の対話フロー
1. GraphViewでノードをクリック
2. BranchViewにコンテキストが設定される
3. 必要に応じてコンテキストを追加選択
4. メッセージを入力して送信
5. 新しいノード・エッジが自動生成

### 4.2 Mergeフロー
1. GraphViewで「Mergeモード」ボタンをクリック
2. 複数ノードをクリックして選択
3. MergePanelでプロンプトを入力
4. 「Execute Merge」で実行
5. 新しいノードが生成され、通常モードに戻る

### 4.3 新トピックフロー
1. BranchViewで「新トピック」ボタンをクリック
2. コンテキストがクリアされる
3. メッセージを入力して送信
4. 独立した新しいノードが生成

## レスポンシブ対応

- **デスクトップ**: 左右分割レイアウト（60:40）
- **タブレット**: 上下分割または全画面切り替え
- **モバイル**: タブ形式で画面切り替え（Graph/Branch/Merge）

## アクセシビリティ

- キーボードナビゲーション対応
- スクリーンリーダー対応
- 色覚異常に配慮した色設計
- 適切なARIAラベル設定

## 将来の拡張

- グラフの表示オプション（階層化、フィルター）
- ノードの検索・ハイライト機能
- エクスポート機能のUI
- セッション間のノード移動機能